<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIXI Network Lab Topology Builder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            overflow: hidden;
        }

        .topology-container {
            display: flex;
            height: 100vh;
            background: var(--surface-color);
        }

        /* Device Palette */
        .device-palette {
            width: 320px;
            background: var(--surface-color);
            border-right: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .palette-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .palette-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .palette-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .device-library {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .device-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .device-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: grab;
            transition: all 0.2s ease;
            background: var(--surface-color);
            user-select: none;
        }

        .device-item:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .device-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }

        .device-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .device-name {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary);
        }

        .tools-section {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .tool-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
        }

        .tool-btn:hover {
            background: var(--background-color);
            border-color: var(--primary-color);
        }

        .tool-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .properties-panel {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--background-color);
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            position: relative;
            background: var(--surface-color);
            overflow: hidden;
        }

        .canvas-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--surface-color);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-status {
            font-weight: 500;
            color: var(--text-primary);
        }

        .canvas-controls {
            display: flex;
            gap: 8px;
        }

        .canvas-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--surface-color);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .canvas-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .canvas {
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle, var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            position: relative;
            overflow: hidden;
        }

        .canvas.drag-over {
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* Network Devices on Canvas */
        .network-device {
            position: absolute;
            width: 100px;
            height: 100px;
            background: var(--surface-color);
            border: 3px solid var(--border-color);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
            user-select: none;
            z-index: 10;
        }

        .network-device:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .network-device.selected {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }

        .network-device.dragging {
            z-index: 1000;
            transform: rotate(5deg) scale(1.05);
        }

        .network-device .device-icon {
            font-size: 2.5rem;
            margin-bottom: 6px;
            color: var(--primary-color);
        }

        .network-device .device-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-secondary);
            line-height: 1.2;
        }

        /* Device Ports */
        .device-port {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--surface-color);
            border: 2px solid var(--secondary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
        }

        .device-port:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.3);
        }

        .device-port.connected {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .device-port.selected {
            background: var(--warning-color);
            border-color: var(--warning-color);
            transform: scale(1.4);
        }

        /* Connection Lines */
        .connection-line {
            position: absolute;
            height: 3px;
            background: var(--primary-color);
            transform-origin: left center;
            z-index: 5;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connection-line:hover {
            background: var(--danger-color);
            height: 4px;
            z-index: 15;
        }

        .connection-line.selected {
            background: var(--warning-color);
            height: 4px;
        }

        /* Connection Path */
        .connection-path {
            position: absolute;
            z-index: 5;
            pointer-events: none;
        }

        .connection-path.active {
            pointer-events: all;
        }

        /* Port Selection Modal */
        .port-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .port-modal.show {
            display: flex;
        }

        .port-modal-content {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .port-modal-header {
            margin-bottom: 20px;
        }

        .port-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .port-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .port-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface-color);
        }

        .port-option:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        .port-option.selected {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .port-option.connected {
            border-color: var(--secondary-color);
            background: var(--background-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .port-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .port-status {
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--background-color);
        }

        /* Utilities */
        .hidden { display: none !important; }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .device-palette {
                width: 280px;
            }
            
            .device-grid {
                grid-template-columns: 1fr;
            }
            
            .canvas-header {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="topology-container">
        <!-- Device Palette -->
        <div class="device-palette">
            <div class="palette-header">
                <h2 class="palette-title">PIXI Device Library</h2>
                <p class="palette-subtitle">Drag devices to canvas to build your network</p>
            </div>
            
            <div class="device-library">
                <div class="device-category">
                    <h3 class="category-title">Network Infrastructure</h3>
                    <div class="device-grid">
                        <div class="device-item" draggable="true" data-device-type="g31" data-ports="8">
                            <div class="device-icon">
                                <!-- <i class="fas fa-network-wired"></i> -->
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="device-name">G31</div>
                        </div>
                        <!-- <div class="device-item" draggable="true" data-device-type="g32" data-ports="24"> -->
                        <div class="device-item" draggable="true" data-device-type="g32" data-ports="8">
                            <div class="device-icon">
                                <!-- <i class="fas fa-project-diagram"></i> -->
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="device-name">G32</div>
                        </div>
                        <!-- <div class="device-item" draggable="true" data-device-type="g34c" data-ports="2"> -->
                        <div class="device-item" draggable="true" data-device-type="g34c" data-ports="8">
                            <div class="device-icon">
                                <!-- <i class="fas fa-wifi"></i> -->
                                 <i class="fas fa-server"></i>
                            </div>
                            <div class="device-name">G34C</div>
                        </div>
                        <!-- <div class="device-item" draggable="true" data-device-type="g42" data-ports="6"> -->
                        <div class="device-item" draggable="true" data-device-type="g42" data-ports="8">
                            <div class="device-icon">
                                <!-- <i class="fas fa-shield-alt"></i> -->
                                 <i class="fas fa-server"></i>
                            </div>
                            <div class="device-name">G42</div>
                        </div>
                    </div>
                </div>
                
                <!-- <div class="device-category">
                    <h3 class="category-title">End Devices</h3>
                    <div class="device-grid">
                        <div class="device-item" draggable="true" data-device-type="server" data-ports="2">
                            <div class="device-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="device-name">Server</div>
                        </div>
                        <div class="device-item" draggable="true" data-device-type="pc" data-ports="1">
                            <div class="device-icon">
                                <i class="fas fa-desktop"></i>
                            </div>
                            <div class="device-name">PC</div>
                        </div>
                        <div class="device-item" draggable="true" data-device-type="laptop" data-ports="1">
                            <div class="device-icon">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <div class="device-name">Laptop</div>
                        </div>
                        <div class="device-item" draggable="true" data-device-type="phone" data-ports="1">
                            <div class="device-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="device-name">IP Phone</div>
                        </div>
                    </div>
                </div> -->
            </div>
            
            <div class="tools-section">
                <h3 class="category-title">Tools</h3>
                <button id="selectTool" class="tool-btn active">
                    <i class="fas fa-mouse-pointer"></i>
                    Select Tool
                </button>
                <button id="connectTool" class="tool-btn">
                    <i class="fas fa-link"></i>
                    Connect Devices
                </button>
                <button id="deleteTool" class="tool-btn">
                    <i class="fas fa-trash"></i>
                    Delete Tool
                </button>
                <button id="clearCanvas" class="tool-btn">
                    <i class="fas fa-eraser"></i>
                    Clear All
                </button>
            </div>
            
            <div class="properties-panel">
                <h3 class="category-title">Properties</h3>
                <div id="deviceProperties">
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                        Select a device to view properties
                    </p>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-header">
                <span id="canvasStatus" class="canvas-status">
                    Drag devices from the library to get started
                </span>
                <div class="canvas-controls">
                    <button id="saveTopology" class="canvas-btn">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button id="loadTopology" class="canvas-btn">
                        <i class="fas fa-folder-open"></i> Load
                    </button>
                    <button id="exportTopology" class="canvas-btn">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none;">
            </svg>
            
            <div id="topologyCanvas" class="canvas"></div>
        </div>
    </div>

    <!-- Port Selection Modal -->
    <div id="portModal" class="port-modal">
        <div class="port-modal-content">
            <div class="port-modal-header">
                <h3 class="port-modal-title">Select Port for Connection</h3>
                <p id="portModalSubtitle" style="color: var(--text-secondary);">Choose a port on the device</p>
            </div>
            
            <div id="portList" class="port-list">
                <!-- Ports will be populated dynamically -->
            </div>
            
            <div class="modal-actions">
                <button id="cancelPortSelection" class="btn btn-outline">Cancel</button>
                <button id="confirmPortSelection" class="btn btn-primary">Connect</button>
            </div>
        </div>
    </div>

    <script>
        class TopologyBuilder {
            constructor() {
                this.devices = [];
                this.connections = [];
                this.selectedDevice = null;
                this.selectedConnection = null;
                this.currentTool = 'select';
                this.connectionInProgress = null;
                this.deviceCounter = 1;
                this.isDragging = false;
                this.draggedDeviceType = null;
                
                this.canvas = document.getElementById('topologyCanvas');
                this.svg = document.getElementById('connectionSvg');
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.updateStatus('Ready - Drag devices from the library to start building');
            }

            setupEventListeners() {
                // Tool buttons
                document.getElementById('selectTool').addEventListener('click', () => this.setTool('select'));
                document.getElementById('connectTool').addEventListener('click', () => this.setTool('connect'));
                document.getElementById('deleteTool').addEventListener('click', () => this.setTool('delete'));
                document.getElementById('clearCanvas').addEventListener('click', () => this.clearCanvas());
                
                // Canvas controls
                document.getElementById('saveTopology').addEventListener('click', () => this.saveTopology());
                document.getElementById('exportTopology').addEventListener('click', () => this.exportTopology());
                
                // Canvas click
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                
                // Port modal
                document.getElementById('cancelPortSelection').addEventListener('click', () => this.hidePortModal());
                document.getElementById('confirmPortSelection').addEventListener('click', () => this.confirmPortSelection());
            }

            setupDragAndDrop() {
                // Device palette drag start
                document.querySelectorAll('.device-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        this.draggedDeviceType = {
                            type: item.dataset.deviceType,
                            ports: parseInt(item.dataset.ports)
                        };
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                });

                // Canvas drop handling
                this.canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    this.canvas.classList.add('drag-over');
                });

                this.canvas.addEventListener('dragleave', () => {
                    this.canvas.classList.remove('drag-over');
                });

                this.canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.canvas.classList.remove('drag-over');
                    this.handleDrop(e);
                });
            }

            handleDrop(e) {
                if (!this.draggedDeviceType) return;

                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - 50; // Center device
                const y = e.clientY - rect.top - 50;

                const device = {
                    id: Date.now(),
                    name: `${this.draggedDeviceType.type.charAt(0).toUpperCase() + this.draggedDeviceType.type.slice(1)}-${this.deviceCounter++}`,
                    type: this.draggedDeviceType.type,
                    x: Math.max(0, Math.min(x, rect.width - 100)),
                    y: Math.max(0, Math.min(y, rect.height - 100)),
                    ports: this.generatePorts(this.draggedDeviceType.type, this.draggedDeviceType.ports)
                };

                this.devices.push(device);
                this.renderDevice(device);
                this.updateStatus(`${device.name} added to topology`);

                this.draggedDeviceType = null;
            }

            generatePorts(deviceType, portCount) {
                const ports = [];
                const portTypes = {

                    g31: ['Line1', 'Line2'],
                    g32: ['Line1', 'Line2'],
                    g34c: ['Line1', 'Line2'],
                    g42: ['Line1', 'Line2'],

                    //router: ['GigabitEthernet', 'FastEthernet'],
                    //switch: ['GigabitEthernet'],
                    //server: ['Ethernet'],
                    //wireless: ['Ethernet', 'Radio'],
                    //firewall: ['GigabitEthernet'],
                    //pc: ['Ethernet'],
                    //laptop: ['Ethernet'],
                    //phone: ['Ethernet']
                };

                const typeOptions = portTypes[deviceType] || ['Ethernet'];

                for (let i = 0; i < portCount; i++) {
                    const portType = typeOptions[i % typeOptions.length];
                    ports.push({
                        id: `${Date.now()}-${i}`,
                        name: `${portType}${Math.floor(i / typeOptions.length)}/${i % typeOptions.length + 1}`,
                        type: portType,
                        connected: false,
                        connectedTo: null
                    });
                }

                return ports;
            }

            renderDevice(device) {
                const deviceEl = document.createElement('div');
                deviceEl.className = 'network-device';
                deviceEl.style.left = device.x + 'px';
                deviceEl.style.top = device.y + 'px';
                deviceEl.setAttribute('data-device-id', device.id);

                const icon = this.getDeviceIcon(device.type);
                deviceEl.innerHTML = `
                    <div class="device-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="device-label">${device.name}</div>
                `;

                // Add event listeners
                deviceEl.addEventListener('click', (e) => this.handleDeviceClick(device, e));
                deviceEl.addEventListener('dblclick', (e) => this.handleDeviceDoubleClick(device, e));
                
                this.makeDeviceDraggable(deviceEl, device);
                this.addDevicePorts(deviceEl, device);

                this.canvas.appendChild(deviceEl);
            }

            makeDeviceDraggable(element, device) {
                let isDragging = false;
                let startX, startY;

                element.addEventListener('mousedown', (e) => {
                    if (this.currentTool !== 'select' || e.target.classList.contains('device-port')) return;

                    isDragging = true;
                    startX = e.clientX - device.x;
                    startY = e.clientY - device.y;
                    element.classList.add('dragging');
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const rect = this.canvas.getBoundingClientRect();
                    device.x = Math.max(0, Math.min(e.clientX - startX, rect.width - 100));
                    device.y = Math.max(0, Math.min(e.clientY - startY, rect.height - 100));

                    element.style.left = device.x + 'px';
                    element.style.top = device.y + 'px';

                    this.updateConnections();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.classList.remove('dragging');
                    }
                });
            }

            addDevicePorts(deviceEl, device) {
                const portPositions = this.getPortPositions(device.ports.length);
                
                device.ports.forEach((port, index) => {
                    const portEl = document.createElement('div');
                    portEl.className = 'device-port';
                    portEl.style.left = portPositions[index].x + 'px';
                    portEl.style.top = portPositions[index].y + 'px';
                    portEl.setAttribute('data-port-id', port.id);
                    portEl.setAttribute('data-device-id', device.id);
                    portEl.title = port.name;

                    portEl.addEventListener('click', (e) => this.handlePortClick(device, port, e));

                    deviceEl.appendChild(portEl);
                });
            }

            getPortPositions(portCount) {
                const positions = [];
                const radius = 45; // Distance from center
                const center = { x: 50, y: 50 }; // Center of 100x100 device

                for (let i = 0; i < portCount; i++) {
                    const angle = (2 * Math.PI * i) / portCount - Math.PI / 2; // Start from top
                    positions.push({
                        x: center.x + radius * Math.cos(angle) - 6, // -6 to center the 12px port
                        y: center.y + radius * Math.sin(angle) - 6
                    });
                }

                return positions;
            }

            handleDeviceClick(device, e) {
                e.stopPropagation();

                if (this.currentTool === 'select') {
                    this.selectDevice(device);
                } else if (this.currentTool === 'delete') {
                    this.deleteDevice(device.id);
                } else if (this.currentTool === 'connect') {
                    this.startConnection(device);
                }
            }

            handleDeviceDoubleClick(device, e) {
                e.stopPropagation();
                this.editDeviceName(device);
            }

            handlePortClick(device, port, e) {
                e.stopPropagation();

                if (this.currentTool === 'connect') {
                    if (!this.connectionInProgress) {
                        this.startConnectionFromPort(device, port);
                    } else {
                        this.completeConnection(device, port);
                    }
                }
            }

            startConnectionFromPort(device, port) {
                if (port.connected) {
                    this.updateStatus('Port is already connected');
                    return;
                }

                this.connectionInProgress = {
                    fromDevice: device,
                    fromPort: port,
                    stage: 'selecting_target'
                };

                this.updateStatus(`Select target port to connect to ${device.name}:${port.name}`);
                this.highlightAvailablePorts();
            }

            completeConnection(toDevice, toPort) {
                if (!this.connectionInProgress) return;

                if (toPort.connected) {
                    this.updateStatus('Target port is already connected');
                    return;
                }

                if (this.connectionInProgress.fromDevice.id === toDevice.id) {
                    this.updateStatus('Cannot connect device to itself');
                    return;
                }

                // Create connection
                const connection = {
                    id: Date.now(),
                    fromDevice: this.connectionInProgress.fromDevice.id,
                    fromPort: this.connectionInProgress.fromPort.id,
                    toDevice: toDevice.id,
                    toPort: toPort.id
                };

                this.connections.push(connection);

                // Update port status
                this.connectionInProgress.fromPort.connected = true;
                this.connectionInProgress.fromPort.connectedTo = toPort.id;
                toPort.connected = true;
                toPort.connectedTo = this.connectionInProgress.fromPort.id;

                this.renderConnection(connection);
                this.updatePortVisuals();
                
                this.updateStatus(`Connected ${this.connectionInProgress.fromDevice.name}:${this.connectionInProgress.fromPort.name} to ${toDevice.name}:${toPort.name}`);
                
                this.connectionInProgress = null;
                this.clearPortHighlights();
            }

            renderConnection(connection) {
                const fromDevice = this.devices.find(d => d.id === connection.fromDevice);
                const toDevice = this.devices.find(d => d.id === connection.toDevice);
                
                if (!fromDevice || !toDevice) return;

                const fromPort = fromDevice.ports.find(p => p.id === connection.fromPort);
                const toPort = toDevice.ports.find(p => p.id === connection.toPort);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('data-connection-id', connection.id);
                line.setAttribute('class', 'connection-line');
                line.style.stroke = 'var(--primary-color)';
                line.style.strokeWidth = '3';
                line.style.cursor = 'pointer';

                this.updateConnectionPosition(line, fromDevice, toDevice, fromPort, toPort);

                line.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (this.currentTool === 'delete') {
                        this.deleteConnection(connection.id);
                    } else {
                        this.selectConnection(connection);
                    }
                });

                this.svg.appendChild(line);
            }

            updateConnectionPosition(line, fromDevice, toDevice, fromPort, toPort) {
                // Calculate port positions relative to canvas
                const fromPortIndex = fromDevice.ports.indexOf(fromPort);
                const toPortIndex = toDevice.ports.indexOf(toPort);
                
                const fromPortPos = this.getPortPositions(fromDevice.ports.length)[fromPortIndex];
                const toPortPos = this.getPortPositions(toDevice.ports.length)[toPortIndex];

                const x1 = fromDevice.x + fromPortPos.x + 6; // +6 to center on port
                const y1 = fromDevice.y + fromPortPos.y + 6;
                const x2 = toDevice.x + toPortPos.x + 6;
                const y2 = toDevice.y + toPortPos.y + 6;

                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
            }

            updateConnections() {
                this.connections.forEach(connection => {
                    const line = this.svg.querySelector(`[data-connection-id="${connection.id}"]`);
                    if (line) {
                        const fromDevice = this.devices.find(d => d.id === connection.fromDevice);
                        const toDevice = this.devices.find(d => d.id === connection.toDevice);
                        const fromPort = fromDevice?.ports.find(p => p.id === connection.fromPort);
                        const toPort = toDevice?.ports.find(p => p.id === connection.toPort);

                        if (fromDevice && toDevice && fromPort && toPort) {
                            this.updateConnectionPosition(line, fromDevice, toDevice, fromPort, toPort);
                        }
                    }
                });
            }

            selectDevice(device) {
                // Clear previous selections
                document.querySelectorAll('.network-device').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('.connection-line').forEach(el => el.classList.remove('selected'));

                // Select device
                const deviceEl = document.querySelector(`[data-device-id="${device.id}"]`);
                deviceEl.classList.add('selected');

                this.selectedDevice = device;
                this.selectedConnection = null;
                this.updatePropertiesPanel();
            }

            selectConnection(connection) {
                // Clear previous selections
                document.querySelectorAll('.network-device').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('.connection-line').forEach(el => el.classList.remove('selected'));

                // Select connection
                const line = this.svg.querySelector(`[data-connection-id="${connection.id}"]`);
                line.classList.add('selected');

                this.selectedConnection = connection;
                this.selectedDevice = null;
                this.updatePropertiesPanel();
            }

            deleteDevice(deviceId) {
                if (!confirm('Delete this device and all its connections?')) return;

                // Remove connections
                this.connections = this.connections.filter(conn => {
                    if (conn.fromDevice === deviceId || conn.toDevice === deviceId) {
                        const line = this.svg.querySelector(`[data-connection-id="${conn.id}"]`);
                        line?.remove();
                        return false;
                    }
                    return true;
                });

                // Remove device
                this.devices = this.devices.filter(d => d.id !== deviceId);
                const deviceEl = document.querySelector(`[data-device-id="${deviceId}"]`);
                deviceEl?.remove();

                // Clear selection
                this.selectedDevice = null;
                this.updatePropertiesPanel();
                this.updateStatus('Device deleted');
            }

            deleteConnection(connectionId) {
                const connection = this.connections.find(c => c.id === connectionId);
                if (!connection) return;

                // Update port status
                const fromDevice = this.devices.find(d => d.id === connection.fromDevice);
                const toDevice = this.devices.find(d => d.id === connection.toDevice);
                
                if (fromDevice && toDevice) {
                    const fromPort = fromDevice.ports.find(p => p.id === connection.fromPort);
                    const toPort = toDevice.ports.find(p => p.id === connection.toPort);
                    
                    if (fromPort) {
                        fromPort.connected = false;
                        fromPort.connectedTo = null;
                    }
                    if (toPort) {
                        toPort.connected = false;
                        toPort.connectedTo = null;
                    }
                }

                // Remove connection
                this.connections = this.connections.filter(c => c.id !== connectionId);
                const line = this.svg.querySelector(`[data-connection-id="${connectionId}"]`);
                line?.remove();

                this.updatePortVisuals();
                this.updateStatus('Connection deleted');
            }

            updatePortVisuals() {
                document.querySelectorAll('.device-port').forEach(portEl => {
                    const deviceId = parseInt(portEl.dataset.deviceId);
                    const portId = portEl.dataset.portId;
                    
                    const device = this.devices.find(d => d.id === deviceId);
                    const port = device?.ports.find(p => p.id === portId);
                    
                    if (port) {
                        portEl.classList.toggle('connected', port.connected);
                    }
                });
            }

            highlightAvailablePorts() {
                document.querySelectorAll('.device-port').forEach(portEl => {
                    const deviceId = parseInt(portEl.dataset.deviceId);
                    const portId = portEl.dataset.portId;
                    
                    if (deviceId !== this.connectionInProgress.fromDevice.id) {
                        const device = this.devices.find(d => d.id === deviceId);
                        const port = device?.ports.find(p => p.id === portId);
                        
                        if (port && !port.connected) {
                            portEl.style.borderColor = 'var(--warning-color)';
                            portEl.style.backgroundColor = 'var(--warning-color)';
                        }
                    }
                });
            }

            clearPortHighlights() {
                document.querySelectorAll('.device-port').forEach(portEl => {
                    portEl.style.borderColor = '';
                    portEl.style.backgroundColor = '';
                });
            }

            setTool(tool) {
                this.currentTool = tool;
                this.connectionInProgress = null;
                this.clearPortHighlights();

                // Update tool buttons
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${tool}Tool`).classList.add('active');

                const messages = {
                    select: 'Click devices to select them',
                    connect: 'Click ports to connect devices',
                    delete: 'Click devices or connections to delete them'
                };

                this.updateStatus(messages[tool] || 'Tool selected');
            }

            clearCanvas() {
                if (!confirm('Clear the entire topology? This cannot be undone.')) return;

                this.devices = [];
                this.connections = [];
                this.selectedDevice = null;
                this.selectedConnection = null;
                this.connectionInProgress = null;
                this.deviceCounter = 1;

                this.canvas.innerHTML = '';
                this.svg.innerHTML = '';
                this.updatePropertiesPanel();
                this.updateStatus('Canvas cleared');
            }

            editDeviceName(device) {
                const newName = prompt('Enter new device name:', device.name);
                if (newName && newName.trim()) {
                    device.name = newName.trim();
                    const deviceEl = document.querySelector(`[data-device-id="${device.id}"] .device-label`);
                    deviceEl.textContent = device.name;
                    this.updatePropertiesPanel();
                }
            }

            updatePropertiesPanel() {
                const panel = document.getElementById('deviceProperties');
                
                if (this.selectedDevice) {
                    const device = this.selectedDevice;
                    const connectedPorts = device.ports.filter(p => p.connected).length;
                    
                    panel.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <h4 style="margin-bottom: 8px; font-weight: 600;">${device.name}</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 12px;">
                                ${device.type.charAt(0).toUpperCase() + device.type.slice(1)}
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 0.875rem; margin-bottom: 4px;">
                                <strong>Position:</strong> (${Math.round(device.x)}, ${Math.round(device.y)})
                            </p>
                            <p style="font-size: 0.875rem; margin-bottom: 4px;">
                                <strong>Total Ports:</strong> ${device.ports.length}
                            </p>
                            <p style="font-size: 0.875rem; margin-bottom: 4px;">
                                <strong>Connected:</strong> ${connectedPorts}
                            </p>
                            <p style="font-size: 0.875rem;">
                                <strong>Available:</strong> ${device.ports.length - connectedPorts}
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button onclick="topology.editDeviceName(topology.selectedDevice)" class="btn btn-outline" style="flex: 1; padding: 8px; font-size: 0.75rem;">
                                <i class="fas fa-edit"></i> Rename
                            </button>
                            <button onclick="topology.deleteDevice(${device.id})" class="btn" style="flex: 1; padding: 8px; font-size: 0.75rem; background: var(--danger-color); color: white;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                } else if (this.selectedConnection) {
                    const connection = this.selectedConnection;
                    const fromDevice = this.devices.find(d => d.id === connection.fromDevice);
                    const toDevice = this.devices.find(d => d.id === connection.toDevice);
                    const fromPort = fromDevice?.ports.find(p => p.id === connection.fromPort);
                    const toPort = toDevice?.ports.find(p => p.id === connection.toPort);
                    
                    panel.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <h4 style="margin-bottom: 8px; font-weight: 600;">Connection</h4>
                            <p style="font-size: 0.875rem; color: var(--text-secondary);">
                                Link between devices
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 0.875rem; margin-bottom: 8px;">
                                <strong>From:</strong><br>
                                ${fromDevice?.name} : ${fromPort?.name}
                            </p>
                            <p style="font-size: 0.875rem; margin-bottom: 8px;">
                                <strong>To:</strong><br>
                                ${toDevice?.name} : ${toPort?.name}
                            </p>
                        </div>
                        
                        <button onclick="topology.deleteConnection(${connection.id})" class="btn" style="width: 100%; padding: 8px; font-size: 0.75rem; background: var(--danger-color); color: white;">
                            <i class="fas fa-unlink"></i> Disconnect
                        </button>
                    `;
                } else {
                    panel.innerHTML = `
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            Select a device or connection to view properties
                        </p>
                    `;
                }
            }

            handleCanvasClick(e) {
                if (e.target === this.canvas) {
                    // Deselect all
                    document.querySelectorAll('.network-device').forEach(el => el.classList.remove('selected'));
                    document.querySelectorAll('.connection-line').forEach(el => el.classList.remove('selected'));
                    
                    this.selectedDevice = null;
                    this.selectedConnection = null;
                    this.updatePropertiesPanel();
                    
                    // Cancel connection in progress
                    if (this.connectionInProgress) {
                        this.connectionInProgress = null;
                        this.clearPortHighlights();
                        this.updateStatus('Connection cancelled');
                    }
                }
            }

            getDeviceIcon(type) {
                const icons = {
                    g31: 'fas fa-server',
                    g32: 'fas fa-server',
                    g34c: 'fas fa-server',   
                    g42c: 'fas fa-server',   
                    //router: 'fas fa-network-wired',
                    //switch: 'fas fa-project-diagram',
                    //server: 'fas fa-server',
                    //wireless: 'fas fa-wifi',
                    //firewall: 'fas fa-shield-alt',
                    //pc: 'fas fa-desktop',
                    //laptop: 'fas fa-laptop',
                    //phone: 'fas fa-mobile-alt'
                };
                //return icons[type] || 'fas fa-desktop';
                return icons[type] || 'fas fa-server';
            }

            updateStatus(message) {
                document.getElementById('canvasStatus').textContent = message;
            }

            saveTopology() {
                const topology = {
                    devices: this.devices,
                    connections: this.connections,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('network_topology', JSON.stringify(topology));
                this.updateStatus('Topology saved locally');
            }

            exportTopology() {
                const topology = {
                    devices: this.devices,
                    connections: this.connections,
                    metadata: {
                        created: new Date().toISOString(),
                        deviceCount: this.devices.length,
                        connectionCount: this.connections.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(topology, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `network_topology_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.updateStatus('Topology exported');
            }

            getTopologyData() {
                return {
                    devices: this.devices,
                    connections: this.connections
                };
            }
        }

        // Initialize topology builder
        const topology = new TopologyBuilder();

        // Global access for button onclick handlers
        window.topology = topology;
    </script>
</body>
</html>